<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­åŠ¨æ€ API æµ‹è¯•å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        .content { padding: 30px; }
        .section {
            margin-bottom: 40px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        .section-header {
            background: #f9fafb;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .section-header h2 { color: #374151; font-size: 1.3rem; margin-bottom: 5px; }
        .section-header p { color: #6b7280; font-size: 0.9rem; }
        .section-content { padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3); }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .response {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .response.success { background: #f0fdf4; border: 1px solid #86efac; color: #14532d; }
        .response.error { background: #fef2f2; border: 1px solid #fca5a5; color: #7f1d1d; }
        .response.info { background: #eff6ff; border: 1px solid #93c5fd; color: #1e3a8a; }
        .auth-status {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        .auth-status.authenticated { background: #f0fdf4; border-color: #86efac; }
        .two-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .two-columns { grid-template-columns: 1fr; } }
        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            overflow: hidden;
        }
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æ ¡å›­åŠ¨æ€ API æµ‹è¯•å·¥å…·</h1>
            <p>æœåŠ¡å™¨åœ°å€: http://106.52.165.122:8080</p>
        </div>

        <div class="content">
            <!-- è®¤è¯çŠ¶æ€ -->
            <div class="auth-status" id="authStatus">
                <strong>ğŸ” è®¤è¯çŠ¶æ€:</strong> <span id="authText">æœªç™»å½•</span>
                <button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="float: right;" class="hidden">é€€å‡ºç™»å½•</button>
            </div>

            <!-- ç”¨æˆ·è®¤è¯ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ”‘ ç”¨æˆ·è®¤è¯</h2>
                    <p>ç”¨æˆ·æ³¨å†Œã€ç™»å½•å’Œè®¤è¯ç›¸å…³æ¥å£</p>
                </div>
                <div class="section-content">
                    <div class="two-columns">
                        <div>
                            <h3>ç”¨æˆ·æ³¨å†Œ</h3>
                            <div class="form-group">
                                <label>ç”¨æˆ·å (3-20å­—ç¬¦)</label>
                                <input type="text" id="regUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
                            </div>
                            <div class="form-group">
                                <label>æ‰‹æœºå· (11ä½)</label>
                                <input type="tel" id="regPhone" placeholder="è¾“å…¥æ‰‹æœºå·">
                            </div>
                            <div class="form-group">
                                <label>å¯†ç  (8-20å­—ç¬¦ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—)</label>
                                <input type="password" id="regPassword" placeholder="è¾“å…¥å¯†ç ">
                            </div>
                            <button class="btn btn-primary" onclick="register()">æ³¨å†Œç”¨æˆ·</button>
                        </div>

                        <div>
                            <h3>ç”¨æˆ·ç™»å½•</h3>
                            <div class="form-group">
                                <label>è´¦å· (ç”¨æˆ·åæˆ–æ‰‹æœºå·)</label>
                                <input type="text" id="loginAccount" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–æ‰‹æœºå·" value="Yw166332">
                            </div>
                            <div class="form-group">
                                <label>å¯†ç </label>
                                <input type="password" id="loginPassword" placeholder="è¾“å…¥å¯†ç " value="JiangCan030">
                            </div>
                            <button class="btn btn-success" onclick="login()">ç™»å½•</button>
                            <button class="btn btn-primary" onclick="quickLogin()">å¿«é€Ÿç™»å½•æµ‹è¯•è´¦å·</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤´åƒä¸Šä¼  -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“¸ å¤´åƒä¸Šä¼ </h2>
                    <p>ä¸Šä¼ å’Œæ›´æ–°ç”¨æˆ·å¤´åƒ</p>
                </div>
                <div class="section-content">
                    <div class="two-columns">
                        <div>
                            <h3>é€‰æ‹©å¤´åƒæ–‡ä»¶</h3>
                            <div class="form-group">
                                <label>å¤´åƒæ–‡ä»¶ (æ”¯æŒ: jpg, jpeg, png, gif, webp)</label>
                                <input type="file" id="avatarFile" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label>å¤´åƒé¢„è§ˆ</label>
                                <div class="avatar-preview" id="avatarPreview">
                                    <span>æ— å¤´åƒ</span>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="uploadAvatar()">ä¸Šä¼ å¤´åƒ</button>
                            <button class="btn btn-success" onclick="getUserProfile()">åˆ·æ–°èµ„æ–™æŸ¥çœ‹å¤´åƒ</button>
                        </div>
                        <div>
                            <h3>å½“å‰ç”¨æˆ·èµ„æ–™</h3>
                            <div id="currentUserInfo" style="padding: 15px; background: #f9fafb; border-radius: 8px;">
                                <p>è¯·å…ˆç™»å½•æŸ¥çœ‹ç”¨æˆ·èµ„æ–™</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠ¨æ€ç®¡ç† -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“„ åŠ¨æ€ç®¡ç†</h2>
                    <p>åŠ¨æ€çš„åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤</p>
                </div>
                <div class="section-content">
                    <div style="margin-bottom: 30px;">
                        <h3>åˆ›å»ºåŠ¨æ€</h3>
                        <div class="form-group">
                            <label>åŠ¨æ€å†…å®¹</label>
                            <textarea id="momentContent" rows="3" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>å›¾ç‰‡åˆ—è¡¨ (JSONæ•°ç»„ï¼Œå¯é€‰)</label>
                            <input type="text" id="momentImages" placeholder='["image1.jpg", "image2.jpg"]'>
                        </div>
                        <div class="form-group">
                            <label>å¯è§æ€§</label>
                            <select id="momentPublic">
                                <option value="true">å…¬å¼€</option>
                                <option value="false">ç§æœ‰</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="createMoment()">å‘å¸ƒåŠ¨æ€</button>
                    </div>

                    <div>
                        <h3>æŸ¥è¯¢åŠ¨æ€</h3>
                        <button class="btn btn-primary" onclick="getMoments()">è·å–åŠ¨æ€åˆ—è¡¨</button>
                        <button class="btn btn-success" onclick="getMyMoments()">è·å–æˆ‘çš„åŠ¨æ€</button>
                    </div>
                </div>
            </div>

            <!-- å“åº”åŒºåŸŸ -->
            <div id="responseContainer"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://106.52.165.122:8080';
        let authToken = localStorage.getItem('authToken') || '';

        window.onload = function() {
            updateAuthStatus();
            setupAvatarPreview();
        };

        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            const authText = document.getElementById('authText');
            const logoutBtn = document.getElementById('logoutBtn');

            if (authToken) {
                authText.textContent = 'å·²ç™»å½•';
                authStatus.classList.add('authenticated');
                logoutBtn.classList.remove('hidden');
                getUserProfile();
            } else {
                authText.textContent = 'æœªç™»å½•';
                authStatus.classList.remove('authenticated');
                logoutBtn.classList.add('hidden');
            }
        }

        function showResponse(data, type = 'info') {
            const container = document.getElementById('responseContainer');
            const responseDiv = document.createElement('div');
            responseDiv.className = `response ${type}`;
            responseDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            container.appendChild(responseDiv);
            
            setTimeout(() => {
                responseDiv.remove();
            }, 8000);
        }

        function getHeaders() {
            const headers = {};
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            return headers;
        }

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, {
                    ...options,
                    headers: {
                        ...getHeaders(),
                        ...options.headers
                    }
                });

                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, data: { message: error.message }, status: 0 };
            }
        }

        async function login() {
            const account = document.getElementById('loginAccount').value;
            const password = document.getElementById('loginPassword').value;

            if (!account || !password) {
                showResponse('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                return;
            }

            const result = await makeRequest('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ account, password })
            });

            if (result.success && result.data.code === 200) {
                authToken = result.data.data.token;
                localStorage.setItem('authToken', authToken);
                updateAuthStatus();
                showResponse('ç™»å½•æˆåŠŸï¼', 'success');
            } else {
                showResponse(result.data, 'error');
            }
        }

        async function quickLogin() {
            const result = await makeRequest('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    account: 'Yw166332', 
                    password: 'JiangCan030' 
                })
            });

            if (result.success && result.data.code === 200) {
                authToken = result.data.data.token;
                localStorage.setItem('authToken', authToken);
                updateAuthStatus();
                showResponse('å¿«é€Ÿç™»å½•æˆåŠŸï¼', 'success');
            } else {
                showResponse(result.data, 'error');
            }
        }

        function logout() {
            authToken = '';
            localStorage.removeItem('authToken');
            updateAuthStatus();
            showResponse('å·²é€€å‡ºç™»å½•', 'info');
        }

        function setupAvatarPreview() {
            const avatarFile = document.getElementById('avatarFile');
            const avatarPreview = document.getElementById('avatarPreview');

            avatarFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        avatarPreview.innerHTML = `<img src="${e.target.result}" alt="å¤´åƒé¢„è§ˆ">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        async function uploadAvatar() {
            if (!authToken) {
                showResponse('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const avatarFile = document.getElementById('avatarFile').files[0];
            if (!avatarFile) {
                showResponse('è¯·é€‰æ‹©å¤´åƒæ–‡ä»¶', 'error');
                return;
            }

            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(avatarFile.type)) {
                showResponse('å¤´åƒæ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼Œæ”¯æŒæ ¼å¼ï¼šjpg, jpeg, png, gif, webp', 'error');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (5MB)
            if (avatarFile.size > 5 * 1024 * 1024) {
                showResponse('å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('avatar', avatarFile);

            try {
                const response = await fetch(API_BASE + '/api/upload/avatar', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                const result = await response.json();
                
                if (result.code === 200) {
                    showResponse('å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'success');
                    // æ›´æ–°ç”¨æˆ·èµ„æ–™æ˜¾ç¤ºå¤´åƒ
                    getUserProfile();
                } else {
                    showResponse(result, 'error');
                }
            } catch (error) {
                showResponse('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        async function getUserProfile() {
            if (!authToken) {
                document.getElementById('currentUserInfo').innerHTML = '<p>è¯·å…ˆç™»å½•æŸ¥çœ‹ç”¨æˆ·èµ„æ–™</p>';
                return;
            }

            const result = await makeRequest('/api/users/profile');
            
            if (result.success && result.data.code === 200) {
                const userInfo = result.data.data;
                const avatarHtml = userInfo.avatar ? 
                    `<img src="${userInfo.avatar}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">` : 
                    '<div style="width: 50px; height: 50px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center;">æ— </div>';
                
                document.getElementById('currentUserInfo').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        ${avatarHtml}
                        <div>
                            <p><strong>ç”¨æˆ·å:</strong> ${userInfo.username}</p>
                            <p><strong>æ‰‹æœºå·:</strong> ${userInfo.phone}</p>
                            <p><strong>ç”¨æˆ·ID:</strong> ${userInfo.userId}</p>
                            ${userInfo.avatar ? `<p><strong>å¤´åƒ:</strong> <a href="${userInfo.avatar}" target="_blank">æŸ¥çœ‹å¤´åƒ</a></p>` : ''}
                        </div>
                    </div>
                `;
            } else {
                showResponse(result.data, 'error');
            }
        }

        async function createMoment() {
            if (!authToken) {
                showResponse('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const content = document.getElementById('momentContent').value;
            if (!content) {
                showResponse('è¯·è¾“å…¥åŠ¨æ€å†…å®¹', 'error');
                return;
            }

            const imagesInput = document.getElementById('momentImages').value;
            const isPublic = document.getElementById('momentPublic').value === 'true';
            const topicsInput = document.getElementById('momentTopics').value;

            let images = [];
            if (imagesInput) {
                try {
                    images = JSON.parse(imagesInput);
                } catch (e) {
                    showResponse('å›¾ç‰‡åˆ—è¡¨æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨JSONæ•°ç»„æ ¼å¼', 'error');
                    return;
                }
            }

            let topics = [];
            if (topicsInput) {
                topics = topicsInput.split(',').map(t => t.trim()).filter(t => t);
            }

            const result = await makeRequest('/api/moments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content,
                    images,
                    isPublic,
                    topics
                })
            });

            showResponse(result.data, result.success ? 'success' : 'error');
        }

        async function getMoments() {
            const result = await makeRequest('/moments?page=1&pageSize=10');
            showResponse(result.data, result.success ? 'success' : 'error');
        }

        async function getMyMoments() {
            if (!authToken) {
                showResponse('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            const result = await makeRequest('/api/moments/my');
            showResponse(result.data, result.success ? 'success' : 'error');
        }

        async function register() {
            const username = document.getElementById('regUsername').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;

            if (!username || !phone || !password) {
                showResponse('è¯·å¡«å†™å®Œæ•´çš„æ³¨å†Œä¿¡æ¯', 'error');
                return;
            }

            const result = await makeRequest('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, phone, password })
            });

            showResponse(result.data, result.success ? 'success' : 'error');
        }
    </script>
</body>
</html>